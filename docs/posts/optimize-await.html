<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="author" content="Abhisek Mallick"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="revisit-after" content="7 days"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><meta name="msapplication-TileColor" content="#ffffff"><title>Optimize Await</title><script>!function(){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><script type="module" crossorigin="" src="/assets/app-CKbQotus.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-CJCeAmPF.css"><link rel="modulepreload" crossorigin="" href="/assets/optimize-await-BfnDFckU.js"><meta property="og:title" content="Optimize Await"><meta name="twitter:title" content="Optimize Await"><meta property="og:image" content="https://antfu.me/og/optimize-await.png"><meta name="twitter:image" content="https://antfu.me/og/optimize-await.png"><meta name="twitter:card" content="summary_large_image"></head><body class="font-sans text-gray-700 dark:text-gray-200 relative"><div id="app" data-server-rendered="true"><!--[--><header class="header z-40" data-v-c774d4db=""><a href="/" class="w-12 h-12 absolute xl:fixed m-5 select-none outline-none" focusable="false" data-v-c774d4db="">A </a><button title="Scroll to top" fixed="" right-3="" bottom-3="" w-10="" h-10="" hover:op100="" rounded-full="" hover-bg-hex-8883="" transition="" duration-300="" z-100="" print:hidden="" class="op0! pointer-events-none" data-v-c774d4db=""><div i-ri-arrow-up-line="" data-v-c774d4db=""></div></button><nav class="nav" data-v-c774d4db=""><div class="spacer" data-v-c774d4db=""></div><div class="right" print:op0="" data-v-c774d4db=""><a href="/posts" class="router-link-active" title="Blog" data-v-c774d4db=""><span class="lt-md:hidden" data-v-c774d4db="">Blog</span><div i-ri-article-line="" md:hidden="" data-v-c774d4db=""></div></a><a href="/talks" class="lt-md:hidden" title="Talks" data-v-c774d4db="">Talks </a><a href="/sponsors-list" class="" title="Sponsors" data-v-c774d4db=""><span class="lt-md:hidden" data-v-c774d4db="">Sponsors</span><div i-ri-heart-line="" class="md:hidden" data-v-c774d4db=""></div></a><a href="https://x.com/Abhisek_217" target="_blank" title="Twitter" class="lt-md:hidden" data-v-c774d4db=""><div i-ri-twitter-x-fill="" data-v-c774d4db=""></div></a><a href="https://github.com/abhisek-ai" target="_blank" title="GitHub" class="lt-md:hidden" data-v-c774d4db=""><div i-uil-github-alt="" data-v-c774d4db=""></div></a><a class="select-none" title="Toggle Color Scheme" data-v-c774d4db=""><div i-ri-sun-line="" dark:i-ri-moon-line=""></div></a></div></nav></header><main class="px-7 py-10 of-x-hidden"><!--[--><!----><div class="prose m-auto mb-8"><h1 class="mb-0 slide-enter-50">Optimize Await</h1><p class="opacity-50 !-mt-6 slide-enter-50">Jul 1, 2021 <span>· 8min</span></p><!----><!----><!----></div><article class=""><!--[--><div class="prose m-auto slide-enter-content"><p><code>async</code> / <code>await</code> in ES7 is truly a life-saver for the JavaScript world. It allows you to avoid <a href="http://callbackhell.com/" target="_blank" rel="noopener">callback hell</a> in your code and make it more readable. However, a common pitfall is that when you <code>await</code> a huge asynchronous task that takes very long time, it blocks the following code and could potentially make your app slow.</p><p>For example:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">app</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#80A665;--s-light:#59873A"> createServer</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">middlewareA</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#80A665;--s-light:#59873A"> resolveMiddlewareA</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">middlewareB</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#80A665;--s-light:#59873A"> resolveMiddlewareB</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">app</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">use</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">middlewareA</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">app</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">use</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">middlewareB</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span></code></pre><p>We have used three <code>await</code> in the example, while the three async function does not actually relying on each other, having them sequentially we are possibility wasted some time of the operations that could be parallelized (IO, Network, etc.)</p><p>So we can use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all" target="_blank" rel="noopener"><code>Promise.all</code></a> to optimize the code:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">app</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> middlewareA</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> middlewareB</span><span style="--s-dark:#666666;--s-light:#999999">]</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#B8A965;--s-light:#998418"> Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">all</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  [</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    createServer</span><span style="--s-dark:#666666;--s-light:#999999">(),</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    resolveMiddlewareA</span><span style="--s-dark:#666666;--s-light:#999999">(),</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    resolveMiddlewareB</span><span style="--s-dark:#666666;--s-light:#999999">(),</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  ],</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">app</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">use</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">middlewareA</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">app</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">use</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">middlewareB</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span></code></pre><p>In another example, you might relying on the async result, but sometime not that urgent:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">async</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createPlugin</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">toolkit</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#80A665;--s-light:#59873A"> initToolKit</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    onHookA</span><span style="--s-dark:#666666;--s-light:#999999">() {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      toolkit</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">invokeA</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    onHookB</span><span style="--s-dark:#666666;--s-light:#999999">() {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      toolkit</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">invokeB</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">plugin</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#80A665;--s-light:#59873A"> createPlugin</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span></code></pre><p>Even though you don’t need <code>toolkit</code> immediately, you are still forced to use <code>async function</code> because the <code>initToolKit</code> is async. To avoid this, we could make the promise been resolved in the hooks instead</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createPlugin</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">toolkitPromise</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> initToolKit</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    async</span><span style="--s-dark:#80A665;--s-light:#59873A"> onHookA</span><span style="--s-dark:#666666;--s-light:#999999">() {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">toolkit</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> toolkitPromise</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      toolkit</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">invokeA</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    async</span><span style="--s-dark:#80A665;--s-light:#59873A"> onHookB</span><span style="--s-dark:#666666;--s-light:#999999">() {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">toolkit</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> toolkitPromise</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      toolkit</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">invokeB</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// now it's sync!</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">plugin</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> createPlugin</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span></code></pre><p>Since a Promise could only <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise#description" target="_blank" rel="noopener">be resolved once</a>, using multiple <code>await</code> for a single Promise instance is <a href="https://blog.ashleygrant.com/2020/04/30/resolved-javascript-promises-can-be-used-multiple-times/" target="_blank" rel="noopener">totally fine</a> - it will return the resolved result immediate if the Promise is allready settled.</p><p>To be more generalized, we could have an utility function like:</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createSingletonPromise</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#80A665;--s-light:#59873A">fn</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Promise</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">_promise</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Promise</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt; | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_promise</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      _promise</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> fn</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _promise</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>This function is also available in my utilities collection <a href="https://github.com/antfu/utils" target="_blank" rel="noopener"><code>@antfu/utils</code></a></p></div><!--]--></article><div class="prose m-auto mt-8 mb-8 slide-enter animate-delay-500 print:hidden"><!--[--><span font-mono="" op50="">&gt; </span><span op50="">comment on </span><a href="https://elk.zone/intent/post?text=Reading%20%40antfu%40m.webtoo.ls's%20https%3A%2F%2Fantfu.me%2Fposts%2Foptimize-await%0A%0AI%20think..." target="_blank" op50="">mastodon</a><span op25=""> / </span><a href="https://twitter.com/intent/tweet?text=Reading%20%40antfu7's%20https%3A%2F%2Fantfu.me%2Fposts%2Foptimize-await%0A%0AI%20think..." target="_blank" op50="">twitter</a><!--]--><br><span font-mono="" op50="">&gt; </span><a href="/posts" class="router-link-active font-mono op50 hover:op75"></a></div><!--]--><div class="mt-10 mb-6 prose m-auto flex slide-enter animate-delay-1200!"><div class="flex-auto"></div></div></main><!----><!--]--></div><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></body></html>